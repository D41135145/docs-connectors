= Configure Web Service Reliable Messaging - Mule 4

Web Service Reliable Messaging (WS-ReliableMessaging) is a protocol that makes the message delivery between two different web services reliable. To consume a web service reliably, associate the message to a Reliable Message (RM) sequence, which is the main resource of reliable messaging. By creating, using, and terminating the RM sequence, you can fully manage it. Additionally, the RM sequence is also a sort of message grouping since you can use the same sequence to send multiple messages reliably. +
To configure WS-ReliableMessaging in Anypoint Connector for Web Service Consumer (Web Service Consumer Connector) both in Anypoint Studio and XML editors, review the following guidelines.

== Limitations

* The web service must accept the sequence offer at the creation sequence request
* The offered sequence cannot be configured
* WS-ReliableMessaging does not support asynchronous scenarios where responses or ack messages are expected in decoupled endpoints


== Configure WS-ReliableMessaging in the Global Element

The following example illustrates how to configure WS-ReliableMessaging in the Web Service Consumer Connector Global Element properties:

. In Studio, open the *Global Element Properties* window of the Web Service Consumer Connector.
. On the *Reliable Messaging* tab, select the reliable messaging *Version* from the dropdown menu.
. In the *Sequence TTL* field, define the maximum time the sequence will live after its creation.
. Click *OK*.

The following screenshot shows the WS-ReliableMessaging configuration in the Global Element Properties window of Studio:

.Configure WS-ReliableMessaging Global Element
image::web-service-consumer-configure-transport.png[Configure WS-ReliableMessaging Global Element]

In the XML editor, the WS-ReliableMessaging configuration `<wsc:wsrm>` is located under the Web Service Consumer Connector configuration `<wsc:config>`:

[source,xml,linenums]
----
<wsc:config name="WSRM_Config">
	<wsc:connection wsdlLocation="http://www.host.com?WSDL" service="Service" port="Port" />
	<wsc:wsrm wsrmVersion="WSRM_11_WSA_200508" wsrmSequenceTtl="1" wsrmSequenceTtlTimeUnit="MINUTES"/>
</wsc:config>
----

== Configure WS-ReliableMessaging Store

Additionally, you can configure an object store to reliable messaging settings. Depending on the scenario and potential unexpected Mule runtime engine interruptions, it may be necessary to persist the sequence's state so that when the Mule application starts and resumes the operation it continues using the same sequences.

The following example illustrates how to declare and reference an object store as the WS-ReliableMessaging store of the Web Service Consumer Connector configuration:

. In Studio, open the *Global Element Properties* window of the Web Service Consumer Connector.
. On the *General > Advanced* tab, under *Web Service Reliable Messaging* section, select an object store from the *Store* dropdown menu.
. Click *OK*

The following screenshot shows the WS-ReliableMessaging store configuration:

.Configure WS-ReliableMessaging store configuration
image::web-service-consumer-configure-transport.png[WS-ReliableMessaging store configuration]

In the XML editor, the WS-ReliableMessaging store  `wsrmStore="Object_store"` is defined under the Web Service Consumer connection `<wsc:connection>`:

[source,xml,linenums]
----
<os:object-store name="Object_store" />
<wsc:config name="WSRM_Config">
  <wsc:connection wsdlLocation="http://www.host.com?WSDL" service="Service" port="Port" wsrmStore="Object_store" />
</wsc:config>
----

== Create a RM Sequence Operation

To create a new Reliable Messaging sequence use the *Create rm sequence* operation that returns the sequence identifier of the created sequence:

. In the *Mule Palette* view, select *Web Service Consumer > Create rm sequence*.
. Drag *Create rm sequence* to the Studio canvas.
. In the *Create rm sequence* properties view, select the desired *Connector configuration* from the dropdown menu.

The following screenshot shows the  *Create rm sequence* operation:
.Create rm sequence
image::web-service-consumer-create-rm.png[Create rm sequence]

In the XML editor, the *Create rm Sequence* operation looks like this:

[source,xml,linenums]
----
<wsc:create-rm-sequence config-ref="WSRM_Config" />
----

== Terminate a RM Sequence Operation

When all the messages of the sequence are sent, it is time to release all the associated resources. To do so, use the *Terminate rm sequence* operation that contains the target sequence identifier.

. In the *Mule Palette* view, select *Web Service Consumer > Terminate rm sequence*.
. Drag *Terminate rm sequence* to the Studio canvas.
. In the *Terminate rm sequence* properties view, in the *General* section, define the *Sequence* identifier.

The following screenshot shows the *Terminate rm sequence* operation:

.Terminate rm sequence
image::web-service-consumer-terminate-rm.png[Terminate rm sequence]

In the XML editor, the *Terminate rm sequence* operation looks like this:

[source,xml,linenums]
----
<wsc:terminate-rm-sequence config-ref="WSRM_Config" sequence="#['TARGET_SEQUENCE_ID']"/>
----

== Configure a RM Sequence for the Consume Operation
To configure WS-ReliableMessaging sequence identifier for the *Consume* operation, follow these steps:

. In the Studio canvas, select the *Consume* operation.
. In the *Consume* operation properties view, select the *Advanced* tab.
. In the *Reliable Messaging* section, define a value for the *Sequence Identifier* field.

The following screenshot shows the WS-ReliableMessaging and *Consume* operation configuration:

.Configure WS-ReliableMessaging Consume configuration
image::web-service-consumer-configure-transport.png[WS-ReliableMessaging Consume configuration]

In the XML editor, the WS-ReliableMessaging configuration `<wsc:reliable-messaging>` is defined under the *Consume* operation `<wsc:consume>`:

[source,xml,linenums]
----
<wsc:consume operation="sayHi" config-ref="WSRM_Config" >
        <wsc:message>
		<wsc:body>#[payload]</wsc:body>
	</wsc:message>
	<wsc:reliable-messaging wsrmSequence="#['TARGET_SEQUENCE_IDENTIFIER']" />
</wsc:consume>
----

== WS-ReliableMessaging XML Example

The following example illustrates how to consume a web service that requires WS-ReliableMessaging. Therefore, you need to:
. Create a sequence and store the received sequence identifier.
. Consume the web service operation using the previously received sequence identifier.
. Release the associated resources by finishing the sequence.

Paste this code into the Studio XML editor to quickly load the flow for the example:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd">
	<wsc:config name="WSRM_Config">
		<wsc:connection wsdlLocation="http://localhost:8080/helloWorld?wsdl" service="HelloWorldService" port="HelloWorldPort" address="http://localhost:8080/helloWorld" />
		<wsc:wsrm wsrmVersion="WSRM_11_WSA_200508" wsrmSequenceTtl="1" wsrmSequenceTtlTimeUnit="MINUTES"/>
	</wsc:config>
	<flow name="WSRM-Example">
		<scheduler>
			<scheduling-strategy>
				<fixed-frequency />
			</scheduling-strategy>
		</scheduler>
		<wsc:create-rm-sequence config-ref="WSRM_Config" target="sequence"/>
		<wsc:consume operation="sayHi" config-ref="WSRM_Config" >
			<wsc:message >
				<wsc:body >
                             #[
                             %dw 2.0
                             output application/xml
                             ns con http://service.soap.clients.namespace/
                             ---
                             con#sayHi: {
                                 arg0: "Sam"
                             }
                             ]>
                             </wsc:body>
			</wsc:message>
			<wsc:reliable-messaging wsrmSequence="#[vars.sequence]" />
		</wsc:consume>
		<wsc:terminate-rm-sequence config-ref="WSRM_Config" sequence="#[vars.sequence]"/>
	</flow>
</mule>
----

== See Also

* xref:web-service-consumer-config-topics.adoc[Web Service Consumer Connector Additional Configuration]
* https://help.mulesoft.com[MuleSoft Help Center]
* xref:web-service-consumer-reference.adoc[Web Service Consumer Connector Reference]
